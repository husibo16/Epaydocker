# -------------------------------
# ğŸš€ Epay é¡¹ç›® Docker Compose é…ç½®æ–‡ä»¶
# ç»“æ„è¯´æ˜ï¼š
# - web: PHP åº”ç”¨å®¹å™¨ï¼ˆè¿è¡Œä»£ç ï¼‰
# - nginx: Web æœåŠ¡å™¨ï¼ˆåå‘ä»£ç†åˆ° webï¼‰
# - mysql: æ•°æ®åº“
# - redis: ç¼“å­˜/é˜Ÿåˆ—
# - scheduler: å®šæ—¶ä»»åŠ¡å®¹å™¨
# -------------------------------

x-app-env: &app-env
  APP_NAME: "Epay"                      # åº”ç”¨åç§°
  APP_ENV: ${APP_ENV:-production}       # åº”ç”¨è¿è¡Œç¯å¢ƒï¼Œé»˜è®¤ production
  APP_URL: ${APP_URL:-http://localhost} # åº”ç”¨è®¿é—®åœ°å€
  TZ: ${TZ:-Asia/Shanghai}              # ç³»ç»Ÿæ—¶åŒºï¼ˆé»˜è®¤ä¸Šæµ·ï¼‰
  DB_HOST: ${DB_HOST:-mysql}            # æ•°æ®åº“ä¸»æœºåï¼ˆå®¹å™¨é—´å¯ç›´æ¥ç”¨æœåŠ¡åé€šä¿¡ï¼‰
  DB_PORT: ${DB_PORT:-3306}             # æ•°æ®åº“ç«¯å£
  REDIS_HOST: ${REDIS_HOST:-redis}      # Redis ä¸»æœºå
  REDIS_PORT: ${REDIS_PORT:-6379}       # Redis ç«¯å£
  PHP_TIMEZONE: ${PHP_TIMEZONE:-}       # PHP æ—¶åŒºï¼ˆå¯è¦†ç›– TZï¼‰

services:
  # ----------------------------------
  # PHP åº”ç”¨å®¹å™¨ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
  # ----------------------------------
  web:
    build:
      context: ..                       # æ„å»ºä¸Šä¸‹æ–‡ï¼ŒæŒ‡å‘é¡¹ç›®æ ¹ç›®å½•
      dockerfile: Docker/Dockerfile     # æŒ‡å®š Dockerfile è·¯å¾„
    image: epay/php:8.2                 # ç”Ÿæˆåçš„é•œåƒåç§°
    restart: unless-stopped             # è‡ªåŠ¨é‡å¯ç­–ç•¥ï¼ˆé™¤éæ‰‹åŠ¨åœæ­¢ï¼‰
    depends_on:
      - mysql
      - redis
    healthcheck:                        # å¥åº·æ£€æŸ¥ï¼Œæ£€æµ‹ PHP-FPM æ˜¯å¦å¯ç”¨
      test: ["CMD-SHELL", "SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    environment:
      <<: *app-env                      # å¼•å…¥å…¬å…±ç¯å¢ƒå˜é‡å—
      PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT:-256M}  # PHP å†…å­˜é™åˆ¶
      PHP_UPLOAD_LIMIT: ${PHP_UPLOAD_LIMIT:-64M}   # PHP ä¸Šä¼ é™åˆ¶
    volumes:
      - ..:/var/www/html:delegated      # æŒ‚è½½æºç ç›®å½•ï¼ˆdelegated æå‡æ€§èƒ½ï¼‰
      - ./php.ini:/usr/local/etc/php/conf.d/99-overrides.ini:ro  # è‡ªå®šä¹‰ PHP é…ç½®
    networks:
      - backend

  # ----------------------------------
  # Nginx åå‘ä»£ç†å®¹å™¨
  # ----------------------------------
  nginx:
    image: nginx:1.27
    restart: unless-stopped
    depends_on:
      - web
    ports:
      - "80:80"                         # æ˜ å°„å®¿ä¸»æœº 80 ç«¯å£
    environment:
      TZ: ${TZ:-Asia/Shanghai}
    volumes:
      - ..:/var/www/html:ro             # æŒ‚è½½åº”ç”¨ä»£ç ï¼ˆåªè¯»ï¼‰
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro  # è‡ªå®šä¹‰ Nginx é…ç½®
      - ./nginx-entrypoint.d/10-listen-on-ipv6-by-default.sh:/docker-entrypoint.d/10-listen-on-ipv6-by-default.sh:ro
      - ./logs/nginx:/var/log/nginx     # æŒ‚è½½æ—¥å¿—ç›®å½•
    healthcheck:                        # æ£€æŸ¥é…ç½®è¯­æ³•æ˜¯å¦æ­£ç¡®
      test: ["CMD-SHELL", "nginx -t"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - backend

  # ----------------------------------
  # MySQL æ•°æ®åº“å®¹å™¨
  # ----------------------------------
  mysql:
    image: mysql:8.0
    restart: unless-stopped
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-secret}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-epay}
      MYSQL_USER: ${MYSQL_USER:-epay}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-epay}
      TZ: ${TZ:-Asia/Shanghai}
    volumes:
      - ./data/mysql:/var/lib/mysql     # æ•°æ®æŒä¹…åŒ–ç›®å½•
    ports:
      - "3306:3306"                     # æš´éœ² MySQL ç«¯å£ï¼ˆå¯é€‰ï¼‰
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$MYSQL_ROOT_PASSWORD --silent"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ----------------------------------
  # Redis ç¼“å­˜/é˜Ÿåˆ—å®¹å™¨
  # ----------------------------------
  redis:
    image: redis:7.0-alpine
    restart: unless-stopped
    command:
      - "sh"
      - "-c"
      - >-
        chown -R redis:redis /data &&
        mkdir -p /data/appendonlydir &&
        exec redis-server --appendonly yes --dir /data --appenddirname appendonlydir
    environment:
      TZ: ${TZ:-Asia/Shanghai}
    volumes:
      - ./data/redis:/data              # æ•°æ®æŒä¹…åŒ–ç›®å½•
    ports:
      - "6379:6379"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------
  # Scheduler å®šæ—¶ä»»åŠ¡å®¹å™¨ï¼ˆè·‘ Laravel/Symfony ç­‰è°ƒåº¦ä»»åŠ¡ï¼‰
  # ----------------------------------
  scheduler:
    build:
      context: ..
      dockerfile: Docker/Dockerfile
      target: scheduler                 # ä½¿ç”¨ Dockerfile ä¸­æŒ‡å®šçš„é˜¶æ®µï¼ˆmulti-stage buildï¼‰
    image: epay/php-scheduler:8.2
    restart: unless-stopped
    depends_on:
      - mysql
      - redis
    environment:
      <<: *app-env
      SCHEDULER_INTERVAL: ${SCHEDULER_INTERVAL:-60} # è°ƒåº¦é—´éš”ï¼ˆç§’ï¼‰
    volumes:
      - ..:/var/www/html:delegated
      - ./php.ini:/usr/local/etc/php/conf.d/99-overrides.ini:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

# ----------------------------------
# ç½‘ç»œå®šä¹‰ï¼ˆæ‰€æœ‰æœåŠ¡å…±äº« backend ç½‘ç»œï¼‰
# ----------------------------------
networks:
  backend:
    driver: bridge
